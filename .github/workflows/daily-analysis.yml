name: Shuangseqiu Data and Analysis

on:
  schedule:
    # UTC时间周日、周二、周四的 22:00，对应北京时间周一、周三、周五的 6:00
    - cron: '0 22 * * 0,2,4'
  workflow_dispatch:

jobs:
  daily_process:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Shanghai

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Set up Python 3.9
      uses: actions/setup-python@v2
      with:
        python-version: 3.9

    - name: Install dependencies
      run: |
        # python -m pip install --upgrade pip
        # pip install -r requirements.txt

    # - name: Run data acquisition script
    #   run: python ssq_data_processor.py

    # - name: Run analysis script
    #   run: python ssq_analyzer.py

    - name: Run analysis script
      run: python ssq_bonus_calculation.py

    - name: Create fixed filename copy
      run: |
        latest_report=$(ls ssq_analysis_output_*.txt | sort -r | head -n 1)
        cp "$latest_report" "latest_ssq_analysis.txt"
        echo "Created fixed filename copy: latest_ssq_analysis.txt"

    - name: Clean old reports - keep only latest 3 by filename timestamp (Debug)
      run: |
        echo "--- Debugging File Cleanup ---"
        echo "Current directory:"
        pwd
        echo "Listing all analysis reports before cleanup:"
        find . -maxdepth 1 -name 'ssq_analysis_output_*.txt' | sort

        file_list_cmd="find . -maxdepth 1 -name 'ssq_analysis_output_*.txt' | sort"
        count=$(eval "$file_list_cmd" | wc -l)
        echo "Total number of reports found: $count"
        
        delete_count=$((count - 3))
        echo "Number of reports to delete: $delete_count"

        if [ $delete_count -gt 0 ]; then
          delete_files=$(eval "$file_list_cmd" | head -n $delete_count)
          echo "Files to delete:"
          echo "$delete_files"
          
          echo "Deleting $delete_count old reports..."
          echo "$delete_files" | while read file; do
            if [ -f "$file" ]; then
              echo "Attempting to remove: $file"
              rm "$file"
              exit_status=$?
              if [ $exit_status -ne 0 ]; then
                echo "Error removing $file. Exit status: $exit_status"
              else
                echo "Successfully removed: $file"
              fi
            else
              echo "File not found, skipping removal: $file"
            fi
          done
        else
          echo "No need to clean reports, have $count (≤3) reports."
        fi
        
        echo "Listing analysis reports after cleanup attempt:"
        find . -maxdepth 1 -name 'ssq_analysis_output_*.txt' | sort
        echo "--- End Debugging ---"

    - name: Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

    - name: Commit updated files (CSV and Analysis Reports)
      run: |
        echo "--- Debugging Commit Step ---"
        echo "Files staged before commit:"
        git status --porcelain
        
        # 关键修复：自动暂存所有已跟踪文件的删除和修改
        git add -u
        
        # 添加可能需要的新生成文件
        git add shuangseqiu.csv
        find . -maxdepth 1 -name 'ssq_analysis_output_*.txt' -print0 | xargs -0 git add
        git add latest_ssq_analysis.txt
        git add latest_ssq_calculation.txt

        echo "Files staged after add:"
        git status --porcelain
        
        # 提交所有变更（包括删除）
        git commit -m "Auto update: Data and Analysis results $(date +'%Y-%m-%d')" || echo "No changes to commit"
        echo "--- End Debugging Commit Step ---"

    - name: Push changes
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}
